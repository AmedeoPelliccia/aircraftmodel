{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "AMPEL360-FAM-ARCH-ELC-001-PNR/pnr_commitment.schema.json",
  "title": "PNR Commitment Payload",
  "description": "JSON Schema for validating PNR (Part Number Registry) Blockchain Thread commitment payloads. Governed by AMPEL360-FAM-ARCH-ELC-001-PNR Rev A.",
  "type": "object",
  "required": [
    "pnr_id",
    "commitment_hash",
    "validity_state",
    "anchored_at",
    "consensus_proof",
    "previous_pnr_id",
    "previous_commitment_hash"
  ],
  "additionalProperties": false,
  "properties": {
    "pnr_id": {
      "type": "string",
      "description": "Unique PNR identifier. Format: PNR:<programme_id>:<family_code>:<event_type>:<sequence>",
      "pattern": "^PNR:[A-Z0-9]+:[A-G*]:[A-Z0-9]+:[0-9]{5}$",
      "examples": [
        "PNR:A360:C:FP01:00001",
        "PNR:A360:*:COMP:00042",
        "PNR:A360:C:STL:00001"
      ]
    },
    "event_type": {
      "type": "string",
      "description": "Type of governance event being anchored.",
      "enum": ["FP01", "FP02", "FP03", "FP04", "FP05", "COMP", "ADR", "GATE", "STL", "SQUAL", "RECOND"]
    },
    "commitment_hash": {
      "type": "string",
      "description": "SHA-256 hex digest of the canonical form of the off-chain artefact being committed.",
      "pattern": "^[0-9a-f]{64}$"
    },
    "validity_state": {
      "type": "string",
      "description": "Current governance validity state of this commitment record.",
      "enum": ["ACTIVE", "SUPERSEDED", "REVOKED", "EXPIRED"]
    },
    "anchored_at": {
      "type": "string",
      "description": "ISO-8601 UTC timestamp of when this commitment was anchored.",
      "format": "date-time"
    },
    "consensus_proof": {
      "type": "object",
      "description": "Set of role-attributed attestations required to anchor this record. Must contain at least one role attestation and a timestamp.",
      "required": ["timestamp"],
      "minProperties": 2,
      "properties": {
        "timestamp": {
          "type": "string",
          "description": "ISO-8601 UTC timestamp of consensus completion.",
          "format": "date-time"
        }
      },
      "additionalProperties": {
        "type": "string",
        "description": "Attestation token or signature reference for a role identifier."
      }
    },
    "previous_pnr_id": {
      "description": "PNR ID of the prior record in the hash chain, or null for genesis records.",
      "oneOf": [
        {
          "type": "string",
          "pattern": "^PNR:[A-Z0-9]+:[A-G*]:[A-Z0-9]+:[0-9]{5}$"
        },
        { "type": "null" }
      ]
    },
    "previous_commitment_hash": {
      "description": "SHA-256 hex digest of the prior commitment payload, or null for genesis records.",
      "oneOf": [
        {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        { "type": "null" }
      ]
    }
  },
  "if": {
    "properties": {
      "previous_pnr_id": { "type": "null" }
    }
  },
  "then": {
    "properties": {
      "previous_commitment_hash": { "type": "null" }
    }
  },
  "else": {
    "properties": {
      "previous_commitment_hash": { "type": "string" }
    },
    "required": ["previous_commitment_hash"]
  }
}
