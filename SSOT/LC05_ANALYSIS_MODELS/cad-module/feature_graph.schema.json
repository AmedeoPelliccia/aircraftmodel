{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ampel360.aircraftmodel.eu/schemas/feature_graph.schema.json",
  "title": "FeatureGraph — Canonical CAD Feature/Constraint Representation",
  "description": "JSON Schema for the FeatureGraph artifact produced by .askm/operator/observer in CAD mode. Represents geometric features, parametric constraints, topological relationships, and design intent extracted from CAD source files. Part of AMPEL360-FAM-LC05-ASKM-CAD-001 Rev A.",
  "type": "object",
  "required": [
    "schema_version",
    "source",
    "features",
    "constraints",
    "topology"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version identifier"
    },
    "source": {
      "$ref": "#/$defs/Source"
    },
    "units": {
      "$ref": "#/$defs/Units"
    },
    "features": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Feature"
      },
      "minItems": 0,
      "description": "Ordered list of geometric features extracted from the source model"
    },
    "constraints": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Constraint"
      },
      "minItems": 0,
      "description": "Parametric and geometric constraints between features"
    },
    "topology": {
      "$ref": "#/$defs/Topology"
    },
    "datums": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Datum"
      },
      "description": "Datum reference frame definitions (GD&T)"
    },
    "materials": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Material"
      },
      "description": "Material assignments"
    },
    "tolerances": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Tolerance"
      },
      "description": "GD&T tolerance specifications"
    },
    "metadata": {
      "$ref": "#/$defs/Metadata"
    }
  },
  "additionalProperties": false,
  "$defs": {
    "Source": {
      "type": "object",
      "required": ["file_name", "file_hash", "format"],
      "properties": {
        "file_name": {
          "type": "string",
          "description": "Original source file name"
        },
        "file_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA-256 hash of the source file (INV-CAD-O3)"
        },
        "format": {
          "type": "string",
          "enum": ["STEP", "IGES", "DXF", "DWG", "STL", "OBJ", "glTF"],
          "description": "Source file format"
        },
        "version": {
          "type": "string",
          "description": "Source file version or revision identifier"
        },
        "extraction_date": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of feature extraction"
        }
      },
      "additionalProperties": false
    },
    "Units": {
      "type": "object",
      "required": ["length"],
      "properties": {
        "length": {
          "type": "string",
          "enum": ["mm", "cm", "m", "in", "ft"],
          "description": "Primary length unit (INV-CAD-O2: must match source)"
        },
        "angle": {
          "type": "string",
          "enum": ["deg", "rad"],
          "default": "deg"
        },
        "mass": {
          "type": "string",
          "enum": ["kg", "g", "lb"],
          "default": "kg"
        }
      },
      "additionalProperties": false
    },
    "Feature": {
      "type": "object",
      "required": ["id", "type", "status"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^F-[0-9]{4}$",
          "description": "Unique feature identifier within this graph"
        },
        "type": {
          "type": "string",
          "enum": [
            "plane",
            "cylinder",
            "cone",
            "sphere",
            "torus",
            "extrude",
            "revolve",
            "loft",
            "sweep",
            "fillet",
            "chamfer",
            "hole",
            "pocket",
            "rib",
            "boss",
            "pattern_linear",
            "pattern_circular",
            "mirror",
            "shell",
            "split",
            "trim",
            "offset",
            "nurbs_surface",
            "nurbs_curve",
            "compound",
            "unknown"
          ],
          "description": "Feature type from the canonical token vocabulary"
        },
        "status": {
          "type": "string",
          "enum": ["complete", "partial", "missing", "unknown"],
          "description": "Extraction confidence (INV-CAD-O1: if ambiguous → missing/unknown)"
        },
        "parameters": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/ParameterValue"
          },
          "description": "Named parametric values for this feature"
        },
        "parent_feature": {
          "type": ["string", "null"],
          "description": "ID of the parent feature (null for root features)"
        },
        "faces": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Topological face identifiers belonging to this feature"
        },
        "edges": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Topological edge identifiers belonging to this feature"
        }
      },
      "additionalProperties": false
    },
    "ParameterValue": {
      "type": "object",
      "required": ["value"],
      "properties": {
        "value": {
          "type": ["number", "string", "boolean", "null"],
          "description": "Parameter value (null if missing/unknown)"
        },
        "unit": {
          "type": "string",
          "description": "Unit override (defaults to graph-level units if omitted)"
        },
        "tolerance_plus": {
          "type": ["number", "null"],
          "description": "Upper tolerance bound"
        },
        "tolerance_minus": {
          "type": ["number", "null"],
          "description": "Lower tolerance bound"
        },
        "datum_ref": {
          "type": ["string", "null"],
          "description": "Reference datum identifier"
        }
      },
      "additionalProperties": false
    },
    "Constraint": {
      "type": "object",
      "required": ["id", "type", "targets"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^C-[0-9]{4}$",
          "description": "Unique constraint identifier"
        },
        "type": {
          "type": "string",
          "enum": [
            "coincident",
            "parallel",
            "perpendicular",
            "tangent",
            "coaxial",
            "concentric",
            "symmetric",
            "equal",
            "fix",
            "distance",
            "angle",
            "midpoint",
            "on_surface",
            "pattern_spacing",
            "unknown"
          ],
          "description": "Geometric constraint type"
        },
        "targets": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "description": "Feature or entity IDs involved in this constraint"
        },
        "value": {
          "type": ["number", "null"],
          "description": "Numeric value for dimensional constraints"
        },
        "unit": {
          "type": ["string", "null"]
        },
        "status": {
          "type": "string",
          "enum": ["satisfied", "violated", "unknown"],
          "default": "unknown"
        }
      },
      "additionalProperties": false
    },
    "Topology": {
      "type": "object",
      "required": ["faces", "edges", "loops"],
      "properties": {
        "faces": {
          "type": "integer",
          "minimum": 0,
          "description": "Total face count in the B-Rep"
        },
        "edges": {
          "type": "integer",
          "minimum": 0,
          "description": "Total edge count"
        },
        "loops": {
          "type": "integer",
          "minimum": 0,
          "description": "Total wire/loop count"
        },
        "shells": {
          "type": "integer",
          "minimum": 0,
          "description": "Shell count"
        },
        "solids": {
          "type": "integer",
          "minimum": 0,
          "description": "Solid body count"
        },
        "is_manifold": {
          "type": ["boolean", "null"],
          "description": "Whether the topology is manifold (null if undetermined)"
        },
        "euler_characteristic": {
          "type": ["integer", "null"],
          "description": "Euler characteristic V − E + F (topological invariant)"
        }
      },
      "additionalProperties": false
    },
    "Datum": {
      "type": "object",
      "required": ["id", "type"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Datum identifier (e.g. A, B, C)"
        },
        "type": {
          "type": "string",
          "enum": ["plane", "axis", "point", "compound"],
          "description": "Datum geometry type"
        },
        "feature_ref": {
          "type": ["string", "null"],
          "description": "Feature ID defining this datum"
        },
        "description": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "Material": {
      "type": "object",
      "required": ["id", "designation"],
      "properties": {
        "id": {
          "type": "string"
        },
        "designation": {
          "type": "string",
          "description": "Material specification (e.g. Al 7075-T6)"
        },
        "standard": {
          "type": "string",
          "description": "Governing standard (e.g. AMS 4078)"
        },
        "source": {
          "type": "string",
          "enum": ["public-mtl", "programme-specific", "unknown"],
          "description": "Provenance of the material data"
        }
      },
      "additionalProperties": false
    },
    "Tolerance": {
      "type": "object",
      "required": ["id", "type", "feature_ref"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^T-[0-9]{4}$"
        },
        "type": {
          "type": "string",
          "enum": [
            "flatness",
            "straightness",
            "circularity",
            "cylindricity",
            "parallelism",
            "perpendicularity",
            "angularity",
            "position",
            "concentricity",
            "symmetry",
            "runout",
            "total_runout",
            "profile_line",
            "profile_surface",
            "unknown"
          ],
          "description": "GD&T tolerance type per ISO 1101 / ASME Y14.5"
        },
        "feature_ref": {
          "type": "string",
          "description": "Feature ID this tolerance applies to"
        },
        "value": {
          "type": "number",
          "minimum": 0,
          "description": "Tolerance zone value"
        },
        "unit": {
          "type": "string"
        },
        "datum_refs": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Ordered datum reference frame (e.g. [A, B, C])"
        },
        "modifier": {
          "type": ["string", "null"],
          "enum": ["MMC", "LMC", "RFS", null],
          "description": "Material condition modifier"
        }
      },
      "additionalProperties": false
    },
    "Metadata": {
      "type": "object",
      "properties": {
        "title": {
          "type": "string"
        },
        "part_number": {
          "type": "string"
        },
        "revision": {
          "type": "string"
        },
        "author": {
          "type": "string"
        },
        "created_date": {
          "type": "string",
          "format": "date"
        },
        "description": {
          "type": "string"
        },
        "ata_chapter": {
          "type": "string",
          "pattern": "^ATA-[0-9]{2}(-[0-9]{2})?$",
          "description": "ATA iSpec 2200 chapter reference"
        },
        "knu_ref": {
          "type": "string",
          "description": "KNU evidence artifact reference"
        },
        "knot_ref": {
          "type": "string",
          "description": "Parent KNOT reference"
        }
      },
      "additionalProperties": false
    }
  }
}
