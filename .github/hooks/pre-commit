#!/usr/bin/env bash
<<<<<<< HEAD
# Pre-commit hook: enforces SSOT/PUB placement rules and KNU traceability.
set -euo pipefail

ERRORS=()

# --- Rule 1: No binaries in SSOT/ ---
BINARY_EXTS="\.pdf$|\.html$|\.docx$|\.xlsx$"
BINARIES=$(git diff --cached --name-only | grep "^SSOT/" | grep -iE "$BINARY_EXTS" || true)
if [ -n "$BINARIES" ]; then
  for f in $BINARIES; do
    ERRORS+=("SSOT binary blocked: $f (use PUB/EXPORT/ instead)")
  done
fi

# --- Rule 2: No raw CSVs in PUB/CSDB/DM/ ---
RAW_CSV=$(git diff --cached --name-only | grep "^PUB/CSDB/DM/.*\.csv$" || true)
if [ -n "$RAW_CSV" ]; then
  for f in $RAW_CSV; do
    ERRORS+=("Raw CSV in DM dir: $f (DMs must be S1000D XML)")
  done
fi

# --- Rule 3: KNU ID traceability in LC02-LC14 artifacts ---
STAGED=$(git diff --cached --name-only | grep -E "^SSOT/LC(0[2-9]|1[0-4])_" || true)
for f in $STAGED; do
  if [ -f "$f" ]; then
    LINES=$(wc -l < "$f")
    if [ "$LINES" -gt 5 ]; then
      if ! grep -qE "KNU-ATA[0-9]{2}-[0-9]{2}-[0-9]{3}" "$f"; then
        ERRORS+=("Missing KNU ID reference: $f ($LINES lines, >5 requires KNU ref)")
      fi
    fi
  fi
done

# --- Report ---
if [ ${#ERRORS[@]} -gt 0 ]; then
  echo "PRE-COMMIT FAILED — ${#ERRORS[@]} error(s):"
  for e in "${ERRORS[@]}"; do
    echo "  ✗ $e"
  done
  exit 1
=======
# ID-A360-Q100 Pre-Commit Hook
# Enforces SSOT boundary and traceability rules

set -euo pipefail

ERRORS=0

# Rule 1: No binary deliverables in SSOT/
FORBIDDEN_IN_SSOT=$(git diff --cached --name-only | grep -E '^SSOT/.*\.(pdf|html|docx|xlsx)$' || true)
if [ -n "$FORBIDDEN_IN_SSOT" ]; then
    echo "❌ Binary deliverables not allowed in SSOT/:"
    echo "$FORBIDDEN_IN_SSOT"
    ERRORS=$((ERRORS + 1))
fi

# Rule 2: No raw CSV in PUB/CSDB/DM/
CSV_IN_DM=$(git diff --cached --name-only | grep -E '^PUB/CSDB/DM/.*\.csv$' || true)
if [ -n "$CSV_IN_DM" ]; then
    echo "❌ Raw CSV files not allowed in PUB/CSDB/DM/:"
    echo "$CSV_IN_DM"
    ERRORS=$((ERRORS + 1))
fi

# Rule 3: LC02-LC14 artifacts must reference a KNU ID
LC_FILES=$(git diff --cached --name-only | grep -E '^SSOT/LC(0[2-9]|1[0-4])' || true)
for f in $LC_FILES; do
    if [ -f "$f" ]; then
        LINES=$(wc -l < "$f")
        if [ "$LINES" -gt 5 ]; then
            if ! grep -qE 'KNU-[A-Z0-9-]+' "$f"; then
                echo "❌ $f has >5 lines but no KNU ID reference"
                ERRORS=$((ERRORS + 1))
            fi
        fi
    fi
done

if [ "$ERRORS" -gt 0 ]; then
    echo ""
    echo "Pre-commit check FAILED with $ERRORS error(s)"
    exit 1
>>>>>>> origin/main
fi

exit 0
