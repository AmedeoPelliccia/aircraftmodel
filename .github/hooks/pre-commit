#!/usr/bin/env bash
# ID-A360-Q100 Pre-Commit Hook
# Enforces SSOT boundary and traceability rules

set -euo pipefail

ERRORS=0

# Rule 1: No binary deliverables in SSOT/
FORBIDDEN_IN_SSOT=$(git diff --cached --name-only | grep -E '^SSOT/.*\.(pdf|html|docx|xlsx)$' || true)
if [ -n "$FORBIDDEN_IN_SSOT" ]; then
    echo "❌ Binary deliverables not allowed in SSOT/:"
    echo "$FORBIDDEN_IN_SSOT"
    ERRORS=$((ERRORS + 1))
fi

# Rule 2: No raw CSV in PUB/CSDB/DM/
CSV_IN_DM=$(git diff --cached --name-only | grep -E '^PUB/CSDB/DM/.*\.csv$' || true)
if [ -n "$CSV_IN_DM" ]; then
    echo "❌ Raw CSV files not allowed in PUB/CSDB/DM/:"
    echo "$CSV_IN_DM"
    ERRORS=$((ERRORS + 1))
fi

# Rule 3: LC02-LC14 artifacts must reference a KNU ID
LC_FILES=$(git diff --cached --name-only | grep -E '^SSOT/LC(0[2-9]|1[0-4])' || true)
for f in $LC_FILES; do
    if [ -f "$f" ]; then
        LINES=$(wc -l < "$f")
        if [ "$LINES" -gt 5 ]; then
            if ! grep -qE 'KNU-[A-Z0-9-]+' "$f"; then
                echo "❌ $f has >5 lines but no KNU ID reference"
                ERRORS=$((ERRORS + 1))
            fi
        fi
    fi
done

if [ "$ERRORS" -gt 0 ]; then
    echo ""
    echo "Pre-commit check FAILED with $ERRORS error(s)"
    exit 1
fi

exit 0
